simulation:
  base_time_unit: hours
  terminating_conditions: TIME(2)
  start_date: 2024-01-01
  random_seed: 42
event_simulation:
  event_flows:
    - flow_id: flow_1_create_orders
      event_flow: flow_1_create_orders
      steps:
        - step_id: create_orders
          step_type: create
          create_config:
            entity_table: Order
            interarrival_time:
              formula: UNIF(5, 10)
              time_unit: minutes
            max_entities: n/a
          next_steps:
            - select_books_for_order
        - step_id: select_books_for_order
          step_type: assign
          assign_config:
            assignments:
              - assignment_type: sql
                expression: >-
                  INSERT INTO OrderBooks (order_ref, book_ref, required_amount)
                  WITH book_popularity AS (
                    SELECT
                      book_key,
                      ROW_NUMBER() OVER (ORDER BY book_key) as row_num,
                      COUNT(*) OVER () as total_count
                    FROM Book
                  ),
                  num_books_to_select AS (
                    SELECT CASE
                      WHEN (ABS(RANDOM()) % 100) < 60 THEN 1
                      WHEN (ABS(RANDOM()) % 100) < 90 THEN 2
                      ELSE 3
                    END as book_count
                  )
                  SELECT
                    Entity.order_key as order_ref,
                    bp.book_key as book_ref,
                    CASE
                      WHEN (ABS(RANDOM()) % 100) < 80 THEN 1
                      WHEN (ABS(RANDOM()) % 100) < 95 THEN 2
                      ELSE 10
                    END as required_amount
                  FROM book_popularity bp, num_books_to_select n
                  WHERE
                    CASE
                      WHEN (ABS(RANDOM()) % 100) < 80
                      THEN bp.row_num <= (bp.total_count * 0.2)
                      ELSE bp.row_num > (bp.total_count * 0.2)
                    END
                  ORDER BY RANDOM()
                  LIMIT (SELECT book_count FROM num_books_to_select)
          next_steps:
            - check_inventory_availability
        - step_id: check_inventory_availability
          step_type: decide
          decide_config:
            decision_type: 2way-condition
            outcomes:
              - outcome_id: outcome_1
                next_step_id: calculate_order_total
                conditions:
                  - if: >-
                      SELECT CASE
                        WHEN COUNT(*) = 0 THEN 'false'
                        WHEN SUM(CASE WHEN ob.required_amount > b.stock_level THEN 1 ELSE 0 END) = 0 THEN 'true'
                        ELSE 'false'
                        END
                      FROM OrderBooks ob
                      LEFT JOIN Book b ON ob.book_ref = b.book_key
                      WHERE ob.order_ref = Entity.order_key
                    is: ==
                    value: true
              - outcome_id: outcome_2
                next_step_id: set_status_backorder
                conditions:
                  - if: Attribute
                    is: ==
        - step_id: calculate_order_total
          step_type: assign
          assign_config:
            assignments:
              - assignment_type: sql
                expression: |-
                  SELECT ROUND(SUM(Book.price * OrderBooks.required_amount), 2)
                  FROM Book
                  JOIN OrderBooks ON Book.book_key = OrderBooks.book_ref
                  WHERE OrderBooks.order_ref = Entity.order_key
                attribute_name: total_cost
          next_steps:
            - payment_decision
        - step_id: payment_decision
          step_type: decide
          decide_config:
            decision_type: 2way-chance
            outcomes:
              - outcome_id: outcome_1
                next_step_id: payment_processing
                conditions:
                  - if: Probability
                    is: ==
                    value: 0.95
              - outcome_id: outcome_2
                next_step_id: payment_retry
                conditions:
                  - if: Probability
                    is: ==
                    value: 0.050000000000000044
        - step_id: payment_processing
          step_type: event
          event_config:
            duration:
              formula: UNIF(0,15)
              time_unit: minutes
            resource_requirements: []
          next_steps:
            - update_inventory
        - step_id: update_inventory
          step_type: assign
          assign_config:
            assignments:
              - assignment_type: sql
                expression: |-
                  UPDATE Book
                  SET stock_level = stock_level - (
                      SELECT OrderBooks.required_amount
                      FROM OrderBooks
                      WHERE OrderBooks.order_ref = Entity.order_key
                      AND OrderBooks.book_ref = Book.book_key
                  )
                  WHERE Book.book_key IN (
                      SELECT book_ref
                      FROM OrderBooks
                      WHERE order_ref = Entity.order_key
                  )
              - assignment_type: attribute
                attribute_name: status
                value: shipped
          next_steps:
            - shipment_decision
        - step_id: shipment_decision
          step_type: decide
          decide_config:
            decision_type: 2way-chance
            outcomes:
              - outcome_id: outcome_1
                next_step_id: local_shipment
                conditions:
                  - if: Probability
                    is: ==
                    value: 0.8
              - outcome_id: outcome_2
                next_step_id: out-of-state_shipment
                conditions:
                  - if: Probability
                    is: ==
                    value: 0.19999999999999996
        - step_id: local_shipment
          step_type: event
          event_config:
            duration:
              formula: NORM(1,2)
              time_unit: days
            resource_requirements: []
          next_steps:
            - assign_status_complete
        - step_id: assign_status_complete
          step_type: assign
          assign_config:
            assignments:
              - assignment_type: attribute
                attribute_name: status
                value: complete
          next_steps:
            - release_1
        - step_id: release_1
          step_type: release
        - step_id: out-of-state_shipment
          step_type: event
          event_config:
            duration:
              formula: UNIF(2,5)
              time_unit: days
            resource_requirements: []
          next_steps:
            - assign_status_complete
        - step_id: payment_retry
          step_type: decide
          decide_config:
            decision_type: 2way-chance
            outcomes:
              - outcome_id: outcome_1
                next_step_id: payment_decision
                conditions:
                  - if: Probability
                    is: ==
                    value: 0.95
              - outcome_id: outcome_2
                next_step_id: assign_1
                conditions:
                  - if: Probability
                    is: ==
                    value: 0.050000000000000044
        - step_id: assign_1
          step_type: assign
          assign_config:
            assignments:
              - assignment_type: attribute
                attribute_name: status
                value: payment_failed
          next_steps:
            - release_2
        - step_id: release_2
          step_type: release
        - step_id: set_status_backorder
          step_type: assign
          assign_config:
            assignments:
              - assignment_type: attribute
                attribute_name: status
                value: backorder
          next_steps:
            - backorder_delay
        - step_id: backorder_delay
          step_type: event
          event_config:
            duration:
              formula: NORM(5, 1)
              time_unit: hours
            resource_requirements: []
          next_steps:
            - restock_inventory
        - step_id: restock_inventory
          step_type: assign
          assign_config:
            assignments:
              - assignment_type: sql
                expression: >
                  UPDATE Book

                  SET stock_level = stock_level + (
                      SELECT COALESCE(
                          MAX(ob.required_amount - COALESCE(b.stock_level, 0) + 20),
                          ob.required_amount + 20)
                      FROM OrderBooks ob
                      LEFT JOIN Book b ON ob.book_ref = b.book_key
                      WHERE ob.order_ref = Entity.order_key
                      AND ob.book_ref = Book.book_key)
                  WHERE Book.book_key IN (
                      SELECT ob.book_ref
                      FROM OrderBooks ob
                      LEFT JOIN Book b ON ob.book_ref = b.book_key
                      WHERE ob.order_ref = Entity.order_key
                      AND COALESCE(b.stock_level, 0) < ob.required_amount)
          next_steps:
            - check_inventory_availability
